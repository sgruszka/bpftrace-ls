#!/usr/bin/env python3

import sys
from pathlib import Path

# Input markdown file
md_path = Path(sys.argv[1])
# Output Rust file
rs_path = Path(sys.argv[2])

content = md_path.read_text()

current_label = None
current_detail = "TODO"
current_docs = "TODO"
out_text = str()

def add_text(label, detail, docs):
    global out_text

    text = f'''
    let json_obj = object! {{
        "label": r#"{label}"#,
        "kind" : 3,
        "detail": r#"{detail}\n"#,
        "documentation" : {{
            "kind": "markdown",
            "value": r#"{docs}"#,
        }},
    }};
    let _ = items.push(json_obj);
    '''

    out_text += text


for line in content.splitlines():
    if line.startswith("### "):
        if current_label:
            add_text(current_label, current_detail, current_docs)

        current_label = line[4:].strip()
        current_detail = ""
        current_docs = "\n"

    elif line.startswith("- ") or line.startswith("* "):
        current_detail += "\n" + line[3:-1]
    else:
        current_docs += line + "\n"

if current_label:
    add_text(current_label, current_detail, current_docs)

begin = f'''
// This file is auto-generated by {sys.argv[0]} , do not edit

use json::object;
pub fn bpftrace_stdlib_functions(items: &mut json::JsonValue) {{
'''

end = '''
}
'''

rs_path.write_text(begin + out_text + end)
